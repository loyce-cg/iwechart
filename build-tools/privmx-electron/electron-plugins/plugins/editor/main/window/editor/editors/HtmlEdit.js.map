{"version":3,"sources":["window/editor/editors/HtmlEdit.ts"],"names":[],"mappings":"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","file":"HtmlEdit.js","sourcesContent":["import {EditorOptions} from \"./Editor\";\nimport {JsonEditor} from \"./JsonEditor\";\nimport {Style} from \"./StyledEditor\";\nimport {JQuery as $, webUtils, Types} from \"pmc-web\";\nimport {NotesPreferences} from \"../../../main/EditorPlugin\";\nimport { component } from \"pmc-web\";\n\nexport interface Raw {\n    content: string;\n    style: Style;\n    metaDataStr?: string;\n}\n\nexport interface State {\n    editor: webUtils.ContentEditableEditor;\n    style: Style;\n    metaDataStr?: string;\n}\n\nexport class HtmlEdit extends JsonEditor<State, Raw> {\n    \n    static clazz = \"HtmlEdit\";\n    static mimetype = \"application/x-stt\";\n    \n    constructor(options: EditorOptions) {\n        super(options);\n    }\n    \n    initContainer(): void {\n        this.$container = $('<div class=\"editor-inner html-editor-container\"></div>');\n        this.initStyle();\n    }\n    \n    sanitize(str: string): string {\n        str = str.replace(/(\\r\\n|\\r|\\n)/g, \"<br>\");\n        return webUtils.ContentEditableEditor.safeHtml(str, undefined, this.taskStatuses, true);\n    }\n    \n    createDataFromState(state: string): State {\n        let data: Raw = state ? JSON.parse(state) : {};\n        let text = data.content;\n        data.style = {\n            name: data.style && data.style.name && data.style.name in component.mindmap.Mindmap.AVAILABLE_STYLES ? data.style.name : component.mindmap.Mindmap.DEFAULT_STYLE_NAME,\n            fontSize: data.style && data.style.fontSize && data.style.fontSize in component.mindmap.Mindmap.AVAILABLE_FONT_SIZES ? data.style.fontSize : component.mindmap.Mindmap.DEFAULT_FONT_SIZE,\n            margin: data.style && data.style.margin && data.style.margin in component.mindmap.Mindmap.AVAILABLE_MARGINS ? data.style.margin : component.mindmap.Mindmap.DEFAULT_MARGIN,\n        };\n        let metaData = webUtils.ContentEditableEditorMetaData.fromString(data.metaDataStr);\n        text = metaData.attach(text);\n        text = text ? this.sanitize(text) : \"\";\n        let $elem = $(\"<div>\").addClass(\"editor-textarea html-editor\");\n        let editor = new webUtils.ContentEditableEditor($elem, {\n            onKeyDown: this.inputEventsHandler.bind(this),\n            onPaste: this.inputEventsHandler.bind(this),\n            onCut: this.inputEventsHandler.bind(this),\n            onInput: this.inputEventsHandler.bind(this),\n            onRequestTaskPicker: (...args: any[]) => {\n                (<any>this.parent).onTaskPickerResult(editor.onTaskPickerResult.bind(editor));\n                return (<any>this.parent).onRequestTaskPicker(...args);\n            },\n            onRequestFilePicker: (...args: any[]) => {\n                (<any>this.parent).onFilePickerResult(editor.onFilePickerResult.bind(editor));\n                return (<any>this.parent).onRequestFilePicker(...args);\n            },\n            relatedHostHash: () => this.relatedHostHash,\n            relatedSectionId: () => this.relatedSectionId,\n        });\n        editor.setValue(text, true, this.editMode);\n        editor.meta = metaData;\n        return {\n            editor: editor,\n            style: data.style,\n            metaDataStr: data.metaDataStr,\n        };\n    }\n    \n    getObjectState(): Raw {\n        let str = this.data.editor.getValue();\n        let { metaData, html } = webUtils.ContentEditableEditorMetaData.extractMetaFromHtml(str);\n        return {\n            content: html,\n            style: this.data.style,\n            metaDataStr: JSON.stringify(metaData),\n        };\n    }\n    \n    confirmSave(initState: string): void {\n        super.confirmSave(initState);\n        this.data.editor.setCurrentValueAsDefault();\n        this.triggerEvent(\"change\", false);\n    }\n    \n    render(): void {\n        if (!this.rendered) {\n            this.rendered = true;\n            this.$container.html(\"\");\n            this.$container.append(this.data.editor.$elem);\n        }\n    }\n    \n    focus(): void {\n        if (this.data && this.data.editor) {\n            this.data.editor.focus();\n        }\n    }\n    \n    inputEventsHandler(event: KeyboardEvent): boolean {\n        switch (event.type) {\n            case \"input\":\n                this.triggerEvent(\"change\", this.isChanged());\n                break;\n            case \"keydown\":\n                if (event.ctrlKey || event.metaKey) {\n                    if (event.keyCode == 65 || event.keyCode == 67) {\n                        return;\n                    }\n                }\n                if (ALLOWED_SINGLE_KEYS.indexOf(event.keyCode) != -1) {\n                    return;\n                }\n            case \"cut\":\n            case \"paste\":\n                if (!this.editMode) {\n                    this.triggerEvent(\"editAttemptWhenNotEditable\", {event: event});\n                    return false;\n                }\n            break;\n        }\n        switch (event.type) {\n            case \"input\":\n                this.data.editor.onInput(event);\n                break;\n            case \"paste\":\n                this.data.editor.onPaste(event);\n                break;\n            case \"cut\":\n                this.data.editor.onCut(event);\n                break;\n            case \"keydown\":\n                this.data.editor.onKeyDown(event);\n                break;\n        }\n        this.triggerEvent(\"change\", this.isChanged());\n    }\n    \n    updateTaskBadges(): void {\n        this.data.editor.setValue(this.data.editor.getValue());\n    }\n    \n}\n\nlet ALLOWED_SINGLE_KEYS = [\n    16, // shift\n    17, // ctrl\n    18, // alt\n    19, // pause\n    20, // capslock\n    27, // escape\n    33, // pageup\n    34, // pagedown\n    35, // end,\n    36, // home\n    37, // left\n    38, // up\n    39, // right\n    40, // down\n    44, // printscreen,\n    93, // contextmenu\n    112, // f1\n    114, // f3\n    115, // f4\n    116, // f5\n    117, // f6\n    118, // f7\n    119, // f8\n    120, // f9\n    121, // f10\n    122, // f11\n    123, // f12,\n    144, // numlock\n    145, // scrolllock\n];\n\n(<any>HtmlEdit.prototype).className = \"com.privmx.plugin.editor.window.editor.editors.HtmlEdit\";"],"sourceRoot":"../../../../src"}