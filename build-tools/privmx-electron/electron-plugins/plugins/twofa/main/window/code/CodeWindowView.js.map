{"version":3,"sources":["window/code/CodeWindowView.ts"],"names":[],"mappings":"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","file":"CodeWindowView.js","sourcesContent":["import {webUtils, window, Types, JQuery as $} from \"pmc-web\";\nimport {func as mainTemplate} from \"./template/main.html\";\nimport {func as messageTemplate} from \"./template/messageTemplate.html\";\nimport {Model} from \"./CodeWindowController\";\nimport { ChallengeModel } from \"../../main/TwofaApi\";\n\nexport class CodeWindowView extends window.base.BaseWindowView<Model> {\n    \n    inputSize: number;\n    digitsOnly: boolean;\n    \n    constructor(parent: Types.app.ViewParent) {\n        super(parent, mainTemplate);\n    }\n    \n    initWindow(model: Model) {\n        this.digitsOnly = true;\n        if (model.data.type == \"googleAuthenticator\") {\n            this.inputSize = 3;\n        }\n        else {\n            this.inputSize = 1;\n        }\n        this.$main.on(\"click\", \".submit-code\", this.onSubmitCodeClick.bind(this));\n        this.$main.on(\"click\", \".cancel\", this.onCancelClick.bind(this));\n        this.$main.on(\"click\", \".resend-code\", this.onResendCodeClick.bind(this));\n        this.$main.find(\".code-input\").on(\"keydown\", this.onKeydown.bind(this));\n        this.$main.find(\".code-input\").on(\"input\", this.onInput.bind(this));\n        this.refreshWindowHeight();\n        this.$main.find(\".code-input\").first().focus();\n        // Typings for navigator.credentials are available from typescript@3.6 DOM lib\n        // navigator.credentials is available is only available in secure context,\n        // in browser its https, in electron you have to set secure context on you own\n        try {\n            if (model.u2f && model.u2f.login) {\n                (<any>navigator).credentials.get({publicKey: model.u2f.login}).then((res: any) => {\n                    let model: ChallengeModel = {\n                        u2fLogin: {\n                            id: res.id,\n                            rawId: <any>new Uint8Array(res.rawId),\n                            type: res.type,\n                            response: {\n                                authenticatorData: <any>new Uint8Array(res.response.authenticatorData),\n                                clientDataJSON: <any>new Uint8Array(res.response.clientDataJSON),\n                                signature: <any>new Uint8Array(res.response.signature),\n                                userHandle: res.response.userHandle ? <any>new Uint8Array(res.response.userHandle) : res.response.userHandle\n                            }\n                        },\n                        rememberDeviceId: this.getRemeberDeviceIdValue()\n                    };\n                    this.triggerEvent(\"submit\", model);\n                })\n                .catch((e: any) => {\n                    this.showMessage(\"Error\", \"error\");\n                    console.error(\"Error\", e, e ? e.message : null, e ? e.stack : null);\n                });\n            }\n            else if (model.u2f && model.u2f.register) {\n                (<any>navigator).credentials.create({publicKey: model.u2f.register}).then((res: any) => {\n                    let model: ChallengeModel = {\n                        u2fRegister: {\n                            id: res.id,\n                            rawId: <any>new Uint8Array(res.rawId),\n                            type: res.type,\n                            response: {\n                                attestationObject: <any>new Uint8Array(res.response.attestationObject),\n                                clientDataJSON: <any>new Uint8Array(res.response.clientDataJSON)\n                            }\n                        },\n                        rememberDeviceId: this.getRemeberDeviceIdValue()\n                    };\n                    this.triggerEvent(\"submit\", model);\n                })\n                .catch((e: any) => {\n                    this.showMessage(\"Error\", \"error\");\n                    console.error(\"Error\", e, e ? e.message : null, e ? e.stack : null);\n                });\n            }\n        }\n        catch (e) {\n            console.log(\"Error\", e);\n            this.showMessage(\"Error\", \"error\");\n        }\n    }\n    \n    onKeydown(event: KeyboardEvent) {\n        if (event.keyCode == 13) {\n            this.submit();\n            return;\n        }\n        if (event.keyCode == 8) {\n            let input = (<HTMLInputElement>event.target);\n            if (input.value.length == 0) {\n                let $prev = $(input).prev();\n                if ($prev.length) {\n                    $prev.focus();\n                }\n            }\n            return;\n        }\n        if (this.digitsOnly) {\n            let allowed = \"0123456789\";\n            if (event.key.length == 1 && allowed.indexOf(event.key) == -1) {\n                event.preventDefault();\n                return false;\n            }\n        }\n    }\n    \n    onInput(event: Event) {\n        let input = (<HTMLInputElement>event.target);\n        if (input.value.length > this.inputSize) {\n            input.value = input.value.substr(0, this.inputSize);\n        }\n        if (input.value.length >= this.inputSize) {\n            let $next = $(input).next();\n            if ($next.length) {\n                $next.focus();\n            }\n        }\n    }\n    \n    onSubmitCodeClick() {\n        this.submit();\n    }\n    \n    onCancelClick(): void {\n        this.triggerEvent(\"cancel\");\n    }\n    \n    onResendCodeClick() {\n        this.disableForm(this.$main.find(\".resend-code\"));\n        this.triggerEvent(\"resend\");\n    }\n    \n    disableForm($button?: JQuery) {\n        this.$main.find(\"input button\").prop(\"disabled\", true);\n        if ($button) {\n            $button.prepend('<i class=\"fa fa-spin fa-circle-o-notch\"></i>');\n        }\n    }\n    \n    enableForm() {\n        this.$main.find(\"input button\").prop(\"disabled\", false);\n        this.$main.find(\"button i\").remove();\n    }\n    \n    getRemeberDeviceIdValue() {\n        return this.$main.find(\".remember-device-id\").is(\":checked\");\n    }\n    \n    submit() {\n        let value = \"\";\n        let invalidElement: HTMLInputElement;\n        this.$main.find(\".code-input\").each((i: number, e: HTMLInputElement) => {\n            if (e.value.length != this.inputSize) {\n                invalidElement = e;\n                return false;\n            }\n            value += e.value;\n        });\n        if (invalidElement != null) {\n            let $activeElement = $(document.activeElement);\n            if (!$activeElement.hasClass(\".code-input\") || (<string>$activeElement.val()).length == this.inputSize) {\n                invalidElement.focus();\n            }\n            return;\n        }\n        this.clearMessage();\n        this.disableForm(this.$main.find(\".submit-code\"));\n        let model: ChallengeModel = {\n            code: value,\n            rememberDeviceId: this.getRemeberDeviceIdValue()\n        };\n        this.triggerEvent(\"submit\", model);\n    }\n    \n    clearState() {\n        this.enableForm();\n        this.$main.find(\".code-input\").first().focus();\n    }\n    \n    showMessage(type: string, message: string): void {\n        let html = this.templateManager.createTemplate(messageTemplate).renderToJQ({type: type, message: message});\n        this.$main.find(\".message\").removeClass(\"hide\").empty().append(html);\n        this.refreshWindowHeight();\n    }\n    \n    clearMessage(): void {\n        this.$main.find(\".message\").addClass(\"hide\");\n        this.refreshWindowHeight();\n    }\n}\n\n(<any>CodeWindowView.prototype).className = \"com.privmx.plugin.twofa.window.code.CodeWindowView\";"],"sourceRoot":"../../../src"}