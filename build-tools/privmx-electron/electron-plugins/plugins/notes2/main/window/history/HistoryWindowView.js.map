{"version":3,"sources":["window/history/HistoryWindowView.ts"],"names":[],"mappings":"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","file":"HistoryWindowView.js","sourcesContent":["import {component, JQuery as $, window, Types, Q, webUtils} from \"pmc-web\";\nimport {func as mainTemplate} from \"./template/main.html\";\nimport {func as versionTemplate} from \"./template/version.html\";\nimport {Model, DescriptorVersion} from \"./HistoryWindowController\";\n\nexport class HistoryWindowView extends window.base.BaseWindowView<Model> {\n    \n    static DOUBLE_CLICK_TIME = 400;\n    \n    versions: component.extlist.ExtListView<DescriptorVersion>;\n    personsComponent: component.persons.PersonsView;\n    personTooltip: component.persontooltip.PersonTooltipView;\n    notifications: component.notification.NotificationView;\n    lastClickTid: NodeJS.Timer;\n    lastClickId: string;\n    \n    constructor(parent: Types.app.ViewParent) {\n        super(parent, mainTemplate);\n        this.personsComponent = this.addComponent(\"personsComponent\", new component.persons.PersonsView(this, this.helper));\n        this.personTooltip = new component.persontooltip.PersonTooltipView(this.templateManager, this.personsComponent);\n        this.notifications = this.addComponent(\"notifications\", new component.notification.NotificationView(this, {xs: true}));\n        \n        this.versions = this.addComponent(\"versions\", new component.extlist.ExtListView(this, {\n            template: versionTemplate\n        }));\n        this.versions.addEventListener(\"ext-list-change\", this.onAfterVersionListRender.bind(this));\n        \n    }\n    \n    initWindow(_model: Model): Q.Promise<void> {\n        return Q().then(() => {\n            this.turnTimeAgoRefresher();\n            this.$main.on(\"click\", \"[data-signature]\", this.onVersionClick.bind(this));\n            this.$main.on(\"click\", \"[data-action='open']\", this.onOpenClick.bind(this));\n            this.$main.on(\"click\", \"[data-action='copy']\", this.onCopyClick.bind(this));\n            this.$main.on(\"click\", \"[data-action='close']\", this.onCloseClick.bind(this));\n            $(document).on(\"keydown\", this.onKeyDown.bind(this));\n            this.personsComponent.$main = this.$main;\n            this.personTooltip.init(this.$main);\n            this.versions.$container = this.$main.find(\".versions\");\n            this.notifications.$container = this.$main.find(\".notifications\");\n            \n            return Q.all([\n                this.personsComponent.triggerInit(),\n                this.versions.triggerInit(),\n                this.notifications.triggerInit()\n            ]);\n        })\n        .then(() => {\n            this.personsComponent.refreshAvatars();\n            this.$main.focus();\n        });\n    }\n    \n    onKeyDown(e: KeyboardEvent): void {\n        if (e.keyCode === webUtils.KEY_CODES.upArrow) {\n            e.preventDefault();\n            this.triggerEvent(\"selectUp\");\n        }\n        else if (e.keyCode === webUtils.KEY_CODES.downArrow) {\n            e.preventDefault();\n            this.triggerEvent(\"selectDown\");\n        }\n        else if (e.keyCode === webUtils.KEY_CODES.enter) {\n            e.preventDefault();\n            this.triggerEvent(\"openSelectedVersion\");\n        }\n        else if (e.keyCode == webUtils.KEY_CODES.c && (e.ctrlKey || e.metaKey)) {\n            e.preventDefault();\n            this.triggerEvent(\"copySelectedVersion\");\n        }\n        else if (e.keyCode === webUtils.KEY_CODES.escape) {\n            e.preventDefault();\n            this.triggerEvent(\"close\");\n        }\n    }\n    \n    onVersionClick(e: MouseEvent): void {\n        let id = $(e.target).closest(\"[data-signature]\").data(\"signature\");\n        this.triggerEvent(\"setActive\", id);\n        if (this.lastClickTid && this.lastClickId == id) {\n            clearTimeout(this.lastClickTid);\n            this.lastClickTid = null;\n            this.lastClickId = null;\n            this.triggerEvent(\"openSelectedVersion\");\n        }\n        else {\n            this.lastClickId = id;\n            this.lastClickTid = setTimeout(() => {\n                this.lastClickTid = null;\n                this.lastClickId = null;\n                //Single click - do nothing, active already selected\n            }, HistoryWindowView.DOUBLE_CLICK_TIME);\n        }\n    }\n    \n    onOpenClick(): void {\n        this.triggerEvent(\"openSelectedVersion\");\n    }\n    \n    onCopyClick(): void {\n        this.triggerEvent(\"copySelectedVersion\");\n    }\n    \n    onCloseClick() {\n        this.triggerEvent(\"close\");\n    }\n    \n    onAfterVersionListRender() {\n        this.personsComponent.refreshAvatars();\n        this.scrollTo(this.$main.find(\".active\"));\n    }\n    \n    scrollTo($ele: JQuery): void {\n        if ($ele.length == 0) {\n            return;\n        }\n        let ch = this.$main.find(\".table-container\")[0];\n        let eBB = $ele[0].getBoundingClientRect();\n        let lBB = ch.getBoundingClientRect();\n        if (eBB.bottom > lBB.bottom) {\n            ch.scrollTo(0, ch.scrollTop + (eBB.bottom - lBB.bottom));\n        }\n        if (eBB.top < lBB.top) {\n            ch.scrollTo(0, ch.scrollTop - (lBB.top - eBB.top));\n        }\n    }\n}\n\n(<any>HistoryWindowView.prototype).className = \"com.privmx.plugin.notes2.window.history.HistoryWindowView\";"],"sourceRoot":"../../../src"}