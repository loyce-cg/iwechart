{"version":3,"sources":["window/videoConference/VideoConferenceWindowController.ts"],"names":[],"mappings":"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","file":"VideoConferenceWindowController.js","sourcesContent":["import {component, mail, utils, window, Types, Q, app} from \"pmc-mail\";\nimport {ChatPlugin, ChatComponentFactory } from \"../../main/ChatPlugin\";\nimport Dependencies = utils.decorators.Dependencies;\nimport { i18n } from \"./i18n/index\";\nimport { VideoConferenceController } from \"../../component/videoconference/VideoConferenceController\";\n\n\nexport interface Model {\n}\n\n@Dependencies([\"videoconference\"])\nexport class VideoConferenceWindowController extends window.base.BaseWindowController {\n    \n    static textsPrefix: string = \"plugin.chat.window.videoconference.\";\n    \n    static registerTexts(localeService: mail.LocaleService): void {\n        localeService.registerTexts(i18n, this.textsPrefix);\n    }\n    \n    chatPlugin: ChatPlugin;\n    componentFactory: ChatComponentFactory;\n    personsComponent: component.persons.PersonsController;\n    videoConference: VideoConferenceController;\n    leftVideoConference: boolean = false;\n    onLeaveVideoConferenceBound: (event: Types.event.LeaveVideoConferenceEvent) => void = this.onLeaveVideoConference.bind(this);\n    closeDeferred: Q.Deferred<void> = Q.defer<void>();\n    \n    constructor(parentWindow: Types.app.WindowParent, public joinVideoConferenceEvent: Types.event.JoinVideoConferenceEvent) {\n        super(parentWindow, __filename, __dirname, {\n            isPublic: false\n        });\n        this.ipcMode = true;\n        let screenSize = this.app.getScreenResolution();\n        let minInitialWindowWidth = 900;\n        let minInitialWindowHeight = 400;\n        let maxInitialWindowWidth = 1800;\n        let maxInitialWindowHeight = 800;\n        let percentInitialWindowWidth = 0.8;\n        let percentInitialWindowHeight = 0.8;\n        let initialWindowWidth: number = Math.max(minInitialWindowWidth, Math.min(maxInitialWindowWidth, percentInitialWindowWidth * screenSize.width));\n        let initialWindowHeight: number = Math.max(minInitialWindowHeight, Math.min(maxInitialWindowHeight, percentInitialWindowHeight * screenSize.height));\n        this.openWindowOptions.width = Math.floor(initialWindowWidth);\n        this.openWindowOptions.height = Math.floor(initialWindowHeight);\n        this.openWindowOptions.electronPartition = app.ElectronPartitions.HTTPS_SECURE_CONTEXT;\n        this.openWindowOptions.backgroundColor = \"#1b1d1d\";\n        this.openWindowOptions.minWidth = 250;\n        this.openWindowOptions.minHeight = 220;\n        this.openWindowOptions.icon = \"privmx-icon privmx-icon-videocall\";\n        this.chatPlugin = this.app.getComponent(\"chat-plugin\");\n        this.chatPlugin.currentVideoConferenceWindowController = this;\n        this.setPluginViewAssets(\"chat\");\n        this.openWindowOptions.title = this.i18n(\"plugin.chat.window.videoconference.title\");\n        this.addViewScript({ path: \"build/jitsi/lib-jitsi-meet.min.js\", plugin: \"chat\" });\n    }\n    \n    init(): Q.IWhenable<void> {\n        return this.app.mailClientApi.checkLoginCore().then(() => {\n            return this.app.mailClientApi.prepareSectionManager();\n        })\n        .then(() => {\n            this.personsComponent = this.addComponent(\"personsComponent\", this.componentFactory.createComponent(\"persons\", [this]));\n            this.videoConference = this.addComponent(\"videoConference\", this.componentFactory.createComponent(\"videoconference\", [this, this.joinVideoConferenceEvent.roomMetadata]));\n            \n            this.bindEvent<Types.event.LeaveVideoConferenceEvent>(this.app, \"leave-video-conference\", this.onLeaveVideoConferenceBound);\n        });\n    }\n    \n    onViewLoad(): void {\n        this.joinVideoConference(this.joinVideoConferenceEvent);\n    }\n    \n    getModel(): Model {\n        return {};\n    }\n    \n    joinVideoConference(event: Types.event.JoinVideoConferenceEvent): Q.Promise<void> {\n        let session = this.app.sessionManager.getSessionByHostHash(event.hostHash);\n        let section = event.section ? event.section : (event.conversation ? event.conversation.section : null);\n        if (session && section) {\n            return this.videoConference.connect(session, section, event.roomMetadata)\n            .fail(e => {\n                this.videoConference.disconnect();\n            });\n        }\n        return Q();\n    }\n    \n    leaveVideoConference(): Q.Promise<void> {\n        return this.videoConference.disconnect();\n    }\n    \n    onLeaveVideoConference(event: Types.event.LeaveVideoConferenceEvent): void {\n        // console.log(\"@@@ onLeaveVideoConference\")\n        if (this.app) {\n            this.unbindEvent<Types.event.LeaveVideoConferenceEvent>(this.app, \"leave-video-conference\", this.onLeaveVideoConferenceBound);\n        }\n        this.leftVideoConference = true;\n        if (this.manager && this.manager.stateListeners) {\n            this.manager.stateChanged(app.BaseWindowManager.STATE_IDLE);\n        }\n        this.close();\n    }\n    \n    beforeClose(_force?: boolean): Q.IWhenable<void> {\n        // console.log(\"@@@ beforeClose\")\n        if (!this.leftVideoConference) {\n            this.manager.stateChanged(app.BaseWindowManager.STATE_CLOSE_CANCELLED);\n            return this.leaveVideoConference()\n            .fin(() => {\n                this.chatPlugin.currentVideoConferenceWindowController = null;\n                this.manager.stateChanged(app.BaseWindowManager.STATE_IDLE);\n            });\n        }\n        else {\n            this.chatPlugin.currentVideoConferenceWindowController = null;\n            this.manager.stateChanged(app.BaseWindowManager.STATE_IDLE);\n        }\n    }\n    \n    onClose(): void {\n        // console.log(\"@@@ onClose\")\n        super.onClose();\n        this.closeDeferred.resolve();\n    }\n    \n}\n\n\n(<any>VideoConferenceWindowController.prototype).className = \"com.privmx.plugin.chat.window.videoConference.VideoConferenceWindowController\";"],"sourceRoot":"../../../src"}